name: Build Cutter (Qt6)

env:
  TAG: "v2.4.1"

on:
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build-linux-arm64:
    name: linux-arm64
    runs-on: ubuntu-24.04-arm

    steps:
    - name: Set timezone
      run: |
        export TZ=UTC
        sudo ln -snf /usr/share/zoneinfo/$TZ /etc/localtime
        echo $TZ | sudo tee /etc/timezone

    - name: Clone cutter repository (stable branch)
      run: |
        git clone --recursive --branch ${{ env.TAG }} https://github.com/rizinorg/cutter.git .

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          qt6-base-dev \
          qt6-base-dev-tools \
          qt6-tools-dev \
          qt6-tools-dev-tools \
          qt6-l10n-tools \
          qt6-svg-dev \
          qt6-multimedia-dev \
          libqt6core5compat6-dev \
          libqt6svg6-dev \
          libqt6opengl6-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          libzstd-dev \
          libzip-dev \
          liblzma-dev \
          libssl-dev \
          pkg-config \
          cmake \
          ninja-build \
          python3 \
          python3-pip \
          python3-setuptools \
          python3-wheel

    - name: Python dependencies
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install meson==0.61.5

    - name: Prepare package id
      shell: bash
      run: |
        if [[ "${{ startsWith(github.event.ref, 'refs/tags') }}" == "true" ]]; then
          PACKAGE_ID="${{ github.event.ref }}"
        else
          PACKAGE_ID="git-$(date +%Y-%m-%d)-${{ github.sha }}"
        fi
        PACKAGE_ID=${PACKAGE_ID##refs/tags/}
        echo "PACKAGE_ID=$PACKAGE_ID" >> $GITHUB_ENV

    - name: Configure & build Cutter
      shell: bash
      run: |
        export LD_LIBRARY_PATH="$(llvm-config --libdir):$LD_LIBRARY_PATH"
        export LANG=C.UTF-8
        export LC_ALL=C.UTF-8
        mkdir build
        cd build

        cmake -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCUTTER_QT=6 \
          -DCUTTER_USE_BUNDLED_RIZIN=ON \
          -DCUTTER_ENABLE_PYTHON=ON \
          -DCUTTER_ENABLE_PYTHON_BINDINGS=OFF \
          -DCUTTER_ENABLE_GRAPHVIZ=ON \
          -DCUTTER_ENABLE_SIGDB=ON \
          -DCUTTER_ENABLE_PACKAGING=ON \
          -DCUTTER_ENABLE_DEPENDENCY_DOWNLOADS=ON \
          -DCUTTER_PACKAGE_RZ_GHIDRA=ON \
          -DCUTTER_PACKAGE_JSDEC=ON \
          -DCUTTER_PACKAGE_RZ_LIBSWIFT=ON \
          -DCUTTER_PACKAGE_RZ_LIBYARA=ON \
          -DCUTTER_PACKAGE_RZ_SILHOUETTE=ON \
          -DCMAKE_INSTALL_PREFIX=appdir/usr \
          -DCMAKE_INSTALL_RPATH_USE_LINK_PATH=ON \
          ..

        ninja
        ninja install

    # -------------------------
    # AppImage (ARM64)
    # -------------------------
    - name: Build ARM64 AppImage
      shell: bash
      run: |
        cd build
        export CUTTER_VERSION=$(python3 ../scripts/get_version.py)
        export VERSION=$CUTTER_VERSION

        wget -c https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-aarch64.AppImage
        chmod +x linuxdeployqt*.AppImage

        ./linuxdeployqt*.AppImage \
          appdir/usr/share/applications/*.desktop \
          -executable=appdir/usr/bin/python3 \
          -appimage \
          -no-strip \
          -exclude-libs=libnss3.so,libnssutil3.so \
          -verbose=2

        APPIMAGE_NAME="Cutter-${PACKAGE_ID}-Linux-arm64.AppImage"
        mv Cutter-*.AppImage "$APPIMAGE_NAME"

        echo "PACKAGE_NAME=$APPIMAGE_NAME" >> $GITHUB_ENV
        echo "PACKAGE_PATH=build/$APPIMAGE_NAME" >> $GITHUB_ENV
        echo "UPLOAD_ASSET_TYPE=application/x-executable" >> $GITHUB_ENV

    # -------------------------
    # DEB package
    # -------------------------
    - name: Build DEB package
      shell: bash
      run: |
        cd build
        cpack -G DEB
        DEB_FILE=$(ls *.deb | head -n1)
        echo "DEB_NAME=$DEB_FILE" >> $GITHUB_ENV

    - uses: actions/upload-artifact@v4
      with:
        name: linux-arm64-artifacts
        path: |
          build/*.AppImage
          build/*.deb

    - name: Upload release assets
      if: github.event_name == 'push' && startsWith(github.event.ref, 'refs/tags')
      uses: actions/upload-release-asset@v1.0.2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.get_release.outputs.upload_url }}
        asset_path: build/${{ env.PACKAGE_NAME }}
        asset_name: ${{ env.PACKAGE_NAME }}
        asset_content_type: ${{ env.UPLOAD_ASSET_TYPE }}